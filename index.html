<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ú–æ—è –æ–±–ª–∞—á–Ω–∞—è —Ñ–∏–ª—å–º–æ—Ç–µ–∫–∞</title>
<style>
body{font-family:Arial,sans-serif;background:#111;color:#fff;margin:0;padding:20px}
h1{text-align:center}
input,textarea,select,button{padding:10px;border-radius:6px;border:none}
button{background:#e50914;color:#fff;cursor:pointer}
.form,.controls{max-width:700px;margin:20px auto;background:#1c1c1c;padding:20px;border-radius:12px}
.form input,.form textarea{width:100%;margin-bottom:10px}
.movies{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px}
.movie{background:#1c1c1c;border-radius:12px;overflow:hidden;cursor:pointer}
.movie img{width:100%;height:260px;object-fit:cover}
.movie .info{padding:10px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center}
.modal-content{background:#1c1c1c;max-width:850px;width:95%;border-radius:12px;padding:20px;display:flex;gap:20px}
.modal-content img{width:230px;border-radius:10px}
.close{position:absolute;top:20px;right:30px;font-size:30px;cursor:pointer}
.rating-user{color:gold;font-size:20px}
.hidden{display:none;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body>
<h1>üé¨ –ú–æ—è –æ–±–ª–∞—á–Ω–∞—è —Ñ–∏–ª—å–º–æ—Ç–µ–∫–∞</h1>

<!-- –§–æ—Ä–º–∞ –ª–æ–≥–∏–Ω–∞ -->
<div class="form" id="loginForm">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button onclick="login()">–í–æ–π—Ç–∏</button>
</div>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞ -->
<div class="form hidden" id="addForm">
<input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)">
<input id="userRating" placeholder="–¢–≤–æ—è –æ—Ü–µ–Ω–∫–∞ (1‚Äì10)">
<button onclick="autoAddMovie()">–î–æ–±–∞–≤–∏—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
<p style="opacity:.7;font-size:14px">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º</p>
<button onclick="logout()">–í—ã–π—Ç–∏</button>
</div>

<div class="controls">
<input id="search" placeholder="–ü–æ–∏—Å–∫" oninput="render()">
<select id="sort" onchange="render()">
<option value="">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
<option value="rating">–ü–æ IMDb</option>
<option value="year">–ü–æ –≥–æ–¥—É</option>
</select>
</div>

<div class="movies" id="movies"></div>

<div class="modal" id="modal" onclick="closeModal()">
<div class="close">‚úñ</div>
<div class="modal-content" onclick="event.stopPropagation()">
<img id="mPoster">
<div>
<h2 id="mTitle"></h2>
<p id="mYear"></p>
<p id="mGenres"></p>
<p id="mDescription"></p>
<p>IMDb: <b id="mImdb"></b></p>
<p>Rotten Tomatoes: <b id="mRt"></b></p>
<p class="rating-user">–¢–≤–æ—è –æ—Ü–µ–Ω–∫–∞: ‚≠ê <span id="mUser"></span>/10</p>
<button onclick="deleteMovie()">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD21W0Y3HY3cStDuOrGwi8lWZ4TFQZQCs0",
  authDomain: "movie-9104a.firebaseapp.com",
  databaseURL: "https://movie-9104a-default-rtdb.firebaseio.com/",
  projectId: "movie-9104a",
  storageBucket: "movie-9104a.appspot.com",
  messagingSenderId: "505111776620",
  appId: "1:505111776620:web:c0afdbe8f222e2836c3749"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let movies = [];
let currentIndex = null;

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
function login(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  firebase.auth().signInWithEmailAndPassword(email,password)
    .then(userCredential=>{
      alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('addForm').classList.remove('hidden');
    })
    .catch(err=>{
      alert(err.message);
    });
}

function logout(){
  firebase.auth().signOut().then(()=>{
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('addForm').classList.add('hidden');
  });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞
async function autoAddMovie(){
  if(!title.value) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
  try {
    const res = await fetch(`https://www.omdbapi.com/?apikey=thewdb&t=${encodeURIComponent(title.value)}`);
    const data = await res.json();
    if(data.Response==='False') return alert('–§–∏–ª—å–º –Ω–µ –Ω–∞–π–¥–µ–Ω');

    const newMovie = {
      title: data.Title,
      year: data.Year,
      genres: data.Genre,
      poster: data.Poster,
      description: data.Plot,
      imdb: data.imdbRating,
      rt: (data.Ratings.find(r=>r.Source==='Rotten Tomatoes')||{}).Value || '‚Äî',
      user: userRating.value || '‚Äî'
    };

    const newRef = db.ref('movies').push();
    await newRef.set(newMovie);

    title.value = userRating.value = '';
  } catch(err){
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞');
  }
}

// –†–µ–Ω–¥–µ—Ä —Ñ–∏–ª—å–º–æ–≤
function render(){
  const list=document.getElementById('movies');
  list.innerHTML='';
  let f=[...movies];
  const q=search.value.toLowerCase();
  if(q) f=f.filter(m=>m.title.toLowerCase().includes(q));
  if(sort.value==='rating') f.sort((a,b)=>(b.imdb||0)-(a.imdb||0));
  if(sort.value==='year') f.sort((a,b)=>b.year-a.year);
  f.forEach((m,i)=>{
    const d=document.createElement('div');
    d.className='movie';
    d.onclick=()=>openModal(i);
    d.innerHTML=`<img src="${m.poster}"><div class="info"><b>${m.title}</b><br>IMDb ‚≠ê ${m.imdb}</div>`;
    list.appendChild(d);
  });
}

// –ú–æ–¥–∞–ª–∫–∞
function openModal(i){
  currentIndex=i;
  const m=movies[i];
  modal.style.display='flex';
  mPoster.src=m.poster; mTitle.textContent=m.title; mYear.textContent='–ì–æ–¥: '+m.year;
  mGenres.textContent='–ñ–∞–Ω—Ä—ã: '+m.genres; mDescription.textContent=m.description;
  mImdb.textContent=m.imdb; mRt.textContent=m.rt; mUser.textContent=m.user;
}
function closeModal(){ modal.style.display='none'; }
function deleteMovie(){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º?')) return;
  const key = movies[currentIndex].key;
  db.ref('movies/'+key).remove();
  closeModal();
}

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –±–∞–∑—É
db.ref('movies').on('value',snapshot=>{
  movies=[];
  snapshot.forEach(child=>{ movies.push({...child.val(), key:child.key}) });
  render();
});
</script>
</body>
</html>
